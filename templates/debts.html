<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fillow - Loans Tracker</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='debts.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
</head>
<body>
  <div class="container">
    <header>
      <a href="/" class="logo">FillUps</a>
      <nav>
        <a href="/budget">Budget</a>
        <a href="/savings">Savings</a>
        <a href="/debts" class="active">Debt</a>
      </nav>
      <a href="/account" class="account-icon" title="Account">
        <i class="fas fa-user"></i>
      </a>
    </header>

    <div class="content">
      <h1 class="savings-title">Your Loans</h1>

      <div class="transaction-form">
        <h3>Add New Loan</h3>
        <form id="loanForm">
          <div class="form-row">
            <div class="form-group">
              <label for="loanAmount">Loan Amount (Rp)</label>
              <input type="number" id="loanAmount" placeholder="Enter loan amount" required min="1"/>
            </div>
            <div class="form-group">
              <label for="interestRate">Interest Rate (%)</label>
              <input type="number" id="interestRate" placeholder="Enter interest rate" required min="0" max="100" step="0.01"/>
            </div>
          </div>
          <div class="form-group">
            <label for="loanDetails">Loan Details</label>
            <input type="text" id="loanDetails" placeholder="E.g. Bank Name, Credit Card, Personal Loan" required/>
          </div>
          <button type="submit" class="submit-btn">
            <i class="fas fa-plus"></i> Add Loan
          </button>
        </form>
      </div>

      <div class="transaction-section">
        <h2>Active Loans</h2>
        <div class="transaction-list" id="loanList">
          <!-- JS will render here -->
        </div>
      </div>
    </div>

    <footer>
      <div class="footer-content">
        <h3>Contact Us</h3>
        <div class="contact-info">
          <p><i class="fas fa-phone"></i> Call Us: +62 811-227-336</p>
          <p><i class="fas fa-map-marker-alt"></i> Location: Binus Alam Sutera</p>
        </div>
      </div>
    </footer>
  </div>

  <script>
    class LoanTracker {
      constructor() {
        this.loans = [];
        this.initializeEventListeners();
        this.loadLoans();
      }

      initializeEventListeners() {
        const form = document.getElementById('loanForm');
        form.addEventListener('submit', (e) => this.handleSubmit(e));
      }

      async loadLoans() {
        const res = await fetch('/debts'); // Use server-rendered page, so no API — use Jinja for initial data
        if (res.ok) {
          const parser = new DOMParser();
          const doc = parser.parseFromString(await res.text(), 'text/html');
          const initialData = JSON.parse(doc.getElementById('initial-loans').textContent);
          this.loans = initialData;
          this.renderLoans();
        } else {
          console.error('Error loading loans');
        }
      }

      async handleSubmit(e) {
        e.preventDefault();
        const amount = parseFloat(document.getElementById('loanAmount').value);
        const details = document.getElementById('loanDetails').value;
        const rate = parseFloat(document.getElementById('interestRate').value);

        if (amount && details && rate >= 0) {
          const response = await fetch('/debts/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              amount: amount,
              interest_rate: rate,
              details: details.trim()
            })
          });
          const result = await response.json();
          if (result.success) {
            location.reload();
          } else {
            alert(result.message || 'Error adding loan.');
          }
        }
      }

      async deleteLoan(id) {
        if (confirm('Are you sure you want to delete this loan?')) {
          const response = await fetch(`/debts/delete/${id}`, { method: 'DELETE' });
          const result = await response.json();
          if (result.success) {
            location.reload();
          } else {
            alert(result.message || 'Error deleting loan.');
          }
        }
      }

      renderLoans() {
        const loanList = document.getElementById('loanList');
        if (this.loans.length === 0) {
          loanList.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-piggy-bank"></i>
              <h3>No loans yet</h3>
              <p>Add your first loan to start tracking your debts</p>
            </div>
          `;
          return;
        }

        const totalDebt = this.loans.reduce((sum, loan) => sum + loan.amount, 0);
        loanList.innerHTML = `
          <div class="transaction-item" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-left: 4px solid #dc2626;">
            <div class="transaction-details">
              <div class="transaction-category">Total Debt</div>
              <div class="transaction-meta">Across ${this.loans.length} loan${this.loans.length > 1 ? 's' : ''}</div>
            </div>
            <div class="transaction-amount" style="color: #dc2626; font-size: 20px;">
              Rp ${totalDebt.toLocaleString('id-ID')}
            </div>
          </div>
          ${this.loans.map(loan => this.renderLoanItem(loan)).join('')}
        `;

        this.loans.forEach(loan => {
          document.getElementById(`toggle-btn-${loan.id}`).onclick = () => this.toggleCalculator(loan.id);
          document.getElementById(`calc-btn-${loan.id}`).onclick = () => this.calculateLoan(loan.id, loan.amount, loan.interest_rate);
          document.getElementById(`delete-btn-${loan.id}`).onclick = () => this.deleteLoan(loan.id);
        });
      }

      renderLoanItem(loan) {
        return `
          <div class="transaction-item">
            <div class="transaction-details">
              <div class="transaction-category">${loan.details}</div>
              <div class="transaction-meta">
                ${loan.interest_rate}% annual interest • Added ${loan.date_added}
              </div>
              <div class="loan-calc-anim" id="calc-${loan.id}">
                <div class="loan-calc-content">
                  <span>Calculate for</span>
                  <input type="number" id="months-${loan.id}" placeholder="12" min="1" max="360" value="12">
                  <span>months</span>
                  <button id="calc-btn-${loan.id}">Calculate</button>
                </div>
                <div class="monthly-result" id="result-${loan.id}"></div>
              </div>
            </div>
            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
              <div class="transaction-amount">
                Rp ${loan.amount.toLocaleString('id-ID')}
              </div>
              <div style="display: flex; gap: 8px;">
                <button id="toggle-btn-${loan.id}" style="background: #1a56bb; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.3s ease;">
                  <i class="fas fa-calculator"></i> Calculate
                </button>
                <button id="delete-btn-${loan.id}" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.3s ease;">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      }

      toggleCalculator(loanId) {
        const calcElement = document.getElementById(`calc-${loanId}`);
        calcElement.classList.toggle('open');
      }

      calculateLoan(loanId, amount, interestRate) {
        const months = parseInt(document.getElementById(`months-${loanId}`).value) || 1;
        const years = months / 12;
        const interestAmount = amount * (interestRate / 100) * years;
        const totalAmount = amount + interestAmount;
        const perMonth = totalAmount / months;
        document.getElementById(`result-${loanId}`).textContent =
          `Total: Rp ${totalAmount.toLocaleString('id-ID', {minimumFractionDigits: 2})} | Per Month: Rp ${perMonth.toLocaleString('id-ID', {minimumFractionDigits: 2})}`;
      }
    }

    const loanTracker = new LoanTracker();
  </script>

  <script id="initial-loans" type="application/json">{{ debts|tojson }}</script>

</body>
</html>
